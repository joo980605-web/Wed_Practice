<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡¤ë¸”ë¦¬ ê²½ë§¤ - LIVE SYSTEM</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --bg-black: #000000; --card-gray: #1c1c1e; --input-gray: #2c2c2e;
            --apple-blue: #0071e3; --apple-gold: #ffd60a; --apple-red: #ff3b30;
            --text-main: #f5f5f7; --text-sub: #86868b;
            --bid-purple: #2d005d;
            --apple-font: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Pretendard", "Segoe UI", Roboto, sans-serif;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: var(--apple-font); background-color: var(--bg-black); color: var(--text-main); -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        h1, h2, h3, p, div, span, button, input { font-family: var(--apple-font) !important; }
        .section-view { display: none; width: 100%; min-height: 100vh; flex-direction: column; align-items: center; }
        .section-view.active { display: flex; }

        /* --- 01. ë©”ì¸ ëœë”© (ì›ë³¸ ë””ìì¸ ì™„ë²½ ë³´ì¡´) --- */
        .bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #000000 100%); z-index: -1; }
        .hero-container { text-align: center; max-width: 1200px; padding: 20px; z-index: 10; margin-top: 12vh; display: flex; flex-direction: column; align-items: center; }
        .main-title { font-size: 88px; font-weight: 800; margin: 0; letter-spacing: -0.04em; background: linear-gradient(180deg, #ffffff 0%, #a1a1a6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sub-title { font-size: 30px; font-weight: 700; margin-top: 12px; color: #f5f5f7; }
        .description { font-size: 19px; color: var(--text-sub); margin: 32px 0 52px 0; line-height: 1.5; font-weight: 400; }
        .start-btn { background-color: var(--apple-blue); color: white; border: none; padding: 18px 56px; border-radius: 980px; font-size: 20px; font-weight: 600; cursor: pointer; transition: 0.3s; }

        /* --- 02. ì„¤ì • í˜ì´ì§€ (5ì—´ ê·¸ë¦¬ë“œ ë³µêµ¬) --- */
        .nav-bar { position: sticky; top: 0; width: 100%; height: 50px; background: rgba(0,0,0,0.7); backdrop-filter: saturate(180%) blur(20px); display: flex; justify-content: center; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.08); z-index: 1000; }
        .made-by { font-size: 11px; color: #555; letter-spacing: 1.5px; font-weight: 800; text-transform: uppercase; }
        .setup-container { width: 95%; max-width: 1200px; padding-bottom: 150px; margin-top: 50px; }
        .setup-card { background-color: var(--card-gray); border-radius: 22px; padding: 34px; margin-bottom: 26px; border: 1px solid rgba(255, 255, 255, 0.02); }
        .list-row { display: grid; grid-template-columns: 45px 1.2fr 2.8fr 1.8fr 0.8fr; gap: 14px; align-items: center; background: rgba(255,255,255,0.03); padding: 14px 18px; border-radius: 16px; margin-bottom: 14px; }
        .btn-group { display: flex; background: #000; border-radius: 11px; padding: 3px; gap: 2px; }
        .btn-item { flex: 1; padding: 9px 0; border: none; background: none; color: #5a5a5e; font-size: 10px; font-weight: 800; cursor: pointer; border-radius: 8px; white-space: nowrap; }
        .btn-item.active { background: #323235; color: white; }
        input { background-color: var(--input-gray); border: none; border-radius: 12px; padding: 14px; color: white; font-size: 15px; outline: none; width: 100%; box-sizing: border-box; }
        .action-bar { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(25px); padding: 22px 0; display: flex; justify-content: center; border-top: 1px solid rgba(255,255,255,0.1); z-index: 100; }

        /* --- 03. ê²½ë§¤ì¥ UI (ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ë° ì• í”Œ ê°ì„± í†µí•©) --- */
        .auction-screen { width: 100%; height: 100vh; background: linear-gradient(180deg, var(--bid-purple) 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bid-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(30px); border-radius: 40px; padding: 50px; width: 90%; max-width: 650px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .timer-progress-wrap { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 100px; margin: 25px 0; overflow: hidden; }
        .timer-progress-fill { height: 100%; background: #ff5252; width: 100%; transition: width 0.1s linear; }
        .current-price-val { font-size: 88px; font-weight: 800; color: var(--apple-gold); margin: 10px 0; letter-spacing: -4px; }
        .presence-dot { width: 10px; height: 10px; border-radius: 50%; background: #444; margin-right: 8px; display: inline-block; }
        .presence-dot.online { background: #34c759; box-shadow: 0 0 10px #34c759; }

        /* ëª¨ë‹¬ (ë³µì‚¬ í‚¤ ì œê±° ë° ì •ë ¬ ê³ ì •) */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); backdrop-filter: blur(20px); display:none; justify-content:center; align-items:center; z-index:2000; }
        .modal-card { background: var(--card-gray); border-radius:30px; padding:40px; width:90%; max-width:550px; text-align:center; border: 1px solid rgba(255,255,255,0.1); }
        .link-box { background:#000; padding:15px; border-radius:12px; border:1px solid #333; margin-bottom:10px; font-size:11px; color:var(--apple-blue); word-break: break-all; text-align: left; }
    </style>
</head>
<body>

    <audio id="sound-success" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <div class="nav-bar">
        <div class="made-by">Gamza â“’ Lolvely</div>
    </div>

    <div id="view-main" class="section-view active">
        <div class="bg-canvas"></div>
        <div class="hero-container">
            <h1 class="main-title">ë¡¤ë¸”ë¦¬ ê²½ë§¤</h1>
            <div class="sub-title">ì‹¤ì‹œê°„ íŒ€ì› ê²½ë§¤ ì‹œìŠ¤í…œ</div>
            <p class="description">ê°ìì˜ í”¼ë•€ ëˆˆë¬¼ì„ ì„ì§„ì•Šê³  ì—´ì‹¬íˆ ë§Œë“  ê²½ë§¤ì‹œìŠ¤í…œ ì…ë‹ˆë‹¤.</p>
            <button class="start-btn" onclick="navigateTo('setup')">ê²½ë§¤ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div id="view-setup" class="section-view">
        <div class="setup-container">
            <section class="setup-card">
                <div class="section-header"><span>01</span> íŒ€ì¥ ì •ë³´ ë° í¬ì¸íŠ¸ ì„¤ì • (1:4 ê·œì¹™)</div>
                <div id="captain-list">
                    <div class="list-row">
                        <div class="num">C1</div>
                        <input type="text" placeholder="ì„±í•¨" class="cap-name-in">
                        <div class="btn-group">
                            <button class="btn-item" onclick="toggleActive(this)">I</button><button class="btn-item" onclick="toggleActive(this)">B</button><button class="btn-item active" onclick="toggleActive(this)">S</button><button class="btn-item" onclick="toggleActive(this)">G</button><button class="btn-item" onclick="toggleActive(this)">E</button><button class="btn-item" onclick="toggleActive(this)">P</button><button class="btn-item" onclick="toggleActive(this)">D</button><button class="btn-item" onclick="toggleActive(this)">M</button><button class="btn-item" onclick="toggleActive(this)">GM</button><button class="btn-item" onclick="toggleActive(this)">C</button>
                        </div>
                        <div class="btn-group">
                            <button class="btn-item active" onclick="toggleActive(this)">TOP</button><button class="btn-item" onclick="toggleActive(this)">JGL</button><button class="btn-item" onclick="toggleActive(this)">MID</button><button class="btn-item" onclick="toggleActive(this)">ADC</button><button class="btn-item" onclick="toggleActive(this)">SUP</button>
                        </div>
                        <input type="number" value="1000" class="cap-pts-in">
                    </div>
                </div>
                <button class="btn-item active" style="margin-top:15px; padding:10px 20px; width:auto;" onclick="addRow('captain-list', 'C')">+ íŒ€ì¥ ì¶”ê°€</button>
            </section>
            <section class="setup-card">
                <div class="section-header"><span>02</span> ê²½ë§¤ ë§¤ë¬¼ ëª…ë‹¨ (1:4 ë¹„ìœ¨ í•„ìˆ˜)</div>
                <div id="player-list">
                    <div class="list-row">
                        <div class="num">1</div><input type="text" placeholder="ì„ ìˆ˜ ì„±í•¨" class="player-name-in">
                        <div class="btn-group">
                            <button class="btn-item" onclick="toggleActive(this)">I</button><button class="btn-item" onclick="toggleActive(this)">B</button><button class="btn-item" onclick="toggleActive(this)">S</button><button class="btn-item active" onclick="toggleActive(this)">G</button><button class="btn-item" onclick="toggleActive(this)">E</button><button class="btn-item" onclick="toggleActive(this)">P</button><button class="btn-item" onclick="toggleActive(this)">D</button>
                        </div>
                        <div class="btn-group">
                            <button class="btn-item active" onclick="toggleActive(this)">TOP</button><button class="btn-item" onclick="toggleActive(this)">JGL</button><button class="btn-item" onclick="toggleActive(this)">MID</button><button class="btn-item" onclick="toggleActive(this)">ADC</button><button class="btn-item" onclick="toggleActive(this)">SUP</button>
                        </div>
                        <div style="width: 80px;"></div>
                    </div>
                </div>
                <button class="btn-item active" style="margin-top:15px; padding:10px 20px; width:auto;" onclick="addRow('player-list', '')">+ ì„ ìˆ˜ ì¶”ê°€</button>
            </section>
        </div>
        <div class="action-bar"><button class="start-btn" style="margin:0; width:90%;" onclick="validateAndCreate()">ğŸš€ ê²½ë§¤ ì„¸ì…˜ ìƒì„± ë° ë§í¬ ë°œê¸‰</button></div>
    </div>

    <div id="view-auction" class="section-view" style="padding:0;">
        <div class="auction-screen">
            <div id="intro-ui" style="text-align:center;">
                <h2 style="color:var(--apple-blue); font-size:24px; letter-spacing:2px;">íŒ€ì¥ ì†Œê°œ íƒ€ì„</h2>
                <h1 id="intro-name" style="font-size:100px; margin:20px 0; font-weight:800;">-</h1>
                <div id="host-intro-ctrl" style="display:none; margin-top:50px;">
                    <p style="margin-bottom:20px;">íŒ€ì¥ ì ‘ì† í˜„í™©:</p>
                    <div id="presence-list" style="display:flex; gap:15px; justify-content:center; margin-bottom:30px;"></div>
                    <button class="btn-primary" id="next-intro-btn" disabled onclick="nextIntro()">ë‹¤ìŒ íŒ€ì¥ ì†Œê°œ (ì£¼ìµœì)</button>
                </div>
            </div>

            <div id="bid-ui" style="display:none; width:100%; flex-direction:column; align-items:center;">
                <div class="bid-card">
                    <div id="timer-text" style="font-size:80px; font-weight:800; color:#ff5252;">10.0ì´ˆ</div>
                    <div class="timer-progress-wrap"><div id="timer-bar" class="timer-progress-fill"></div></div>
                    
                    <h1 id="board-p-name" style="font-size:60px; margin:0; font-weight:800;">ë§¤ë¬¼ ì„ íƒ ëŒ€ê¸°</h1>
                    <div class="current-price-val" id="board-price">0p</div>
                    <p style="color:var(--text-sub);">ìµœê³  ì…ì°°ì: <span id="board-winner" style="color:var(--apple-blue); font-weight:700;">ì—†ìŒ</span></p>

                    <div id="cap-bid-ctrl" style="display:none; margin-top:30px;">
                        <p style="color:var(--text-sub); margin-bottom:15px;">ë‚´ ë‚¨ì€ í¬ì¸íŠ¸: <b id="my-pts" style="color:var(--apple-gold);">1000p</b></p>
                        <div style="display:flex; gap:15px; justify-content:center; align-items:center;">
                            <button class="btn-item active" style="width:60px; height:60px; font-size:18px;" onclick="adjBid(-10)">-10</button>
                            <input type="number" id="bid-input-val" value="50" style="background:#000; color:#fff; font-size:40px; text-align:center; width:120px; border:1px solid #333; border-radius:15px; padding:10px;" readonly>
                            <button class="btn-item active" style="width:60px; height:60px; font-size:18px;" onclick="adjBid(10)">+10</button>
                        </div>
                        <button class="btn-primary" style="margin-top:30px; width:100%;" onclick="placeBid()">ì…ì°°í•˜ê¸° (íƒ€ì´ë¨¸ ì—°ì¥)</button>
                    </div>

                    <div id="host-bid-ctrl" style="display:none; margin-top:40px;">
                        <div id="player-selector" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:20px;"></div>
                        <button class="btn-primary" style="background:var(--apple-red);" onclick="killSession()">ê²½ë§¤ ì¢…ë£Œ ë° ë°ì´í„° íê¸°</button>
                    </div>
                </div>
                <div id="log-chips" style="display:flex; gap:10px; margin-top:40px; overflow-x:auto; width:90%; justify-content:center;"></div>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-card">
            <h2>ë°© ìƒì„± ì™„ë£Œ (ë§í¬ ìˆ˜ë™ ë³µì‚¬)</h2>
            <div id="link-res-box" style="margin-top:25px;"></div>
            <button class="btn-primary" style="width:100%; margin-top:30px;" onclick="enterHost()">ì£¼ìµœìë¡œ ì…ì¥</button>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA_NKmt-NWatDgjUZDO2VfSQM5r0hLWJQo",
            authDomain: "lolvelyauction.firebaseapp.com",
            databaseURL: "https://lolvelyauction-default-rtdb.firebaseio.com",
            projectId: "lolvelyauction",
            storageBucket: "lolvelyauction.firebasestorage.app",
            messagingSenderId: "916363598038",
            appId: "1:916363598038:web:a7bed88ea3541111b7d177"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomID = ""; let auth = ""; let myName = ""; let tIdx = 0; let timerMax = 50;

        function toggleActive(b) { b.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); }
        function navigateTo(id) { document.querySelectorAll('.section-view').forEach(v => v.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); if(id === 'auction') syncLive(); }
        function addRow(id, pre) { const list = document.getElementById(id); const row = list.children[0].cloneNode(true); row.querySelector('.num').innerText = pre + (list.children.length + 1); row.querySelectorAll('input').forEach(i => i.value=''); list.appendChild(row); }

        // [í•µì‹¬ ê·œì¹™ 1, 2] 1:4 ì¸ì› ë° ì •ë³´ ì…ë ¥ ê²€ì¦
        function validateAndCreate() {
            const caps = document.querySelectorAll('#captain-list .list-row');
            const players = document.querySelectorAll('#player-list .list-row');
            if (players.length !== caps.length * 4) { alert("ì¸ì›ìˆ˜ ê·œì¹™ ìœ„ë°˜! íŒ€ì¥ 1ëª…ë‹¹ ì„ ìˆ˜ 4ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
            let allIn = true; document.querySelectorAll('input[type="text"]').forEach(i => { if(!i.value) allIn = false; });
            if(!allIn) { alert("ëª¨ë“  ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

            roomID = "room_" + Date.now();
            let capData = {}; let pData = [];
            caps.forEach((row, i) => { capData[i] = { name: row.querySelector('.cap-name-in').value, pts: parseInt(row.querySelector('.cap-pts-in').value), online: false }; });
            players.forEach(row => { pData.push({ name: row.querySelector('.player-name-in').value }); });

            db.ref('rooms/' + roomID).set({ status: "INTRO", curIdx: 0, caps: capData, players: pData, curBid: 0, timer: timerMax }).then(() => {
                const base = window.location.href.split('?')[0];
                let links = `<div class="link-box">ğŸ‘‘ ì£¼ìµœì: ${base}?room=${roomID}&auth=host</div>`;
                Object.values(capData).forEach((c, i) => { links += `<div class="link-box">${c.name}: ${base}?room=${roomID}&auth=cap&t=${i}&name=${encodeURIComponent(c.name)}</div>`; });
                document.getElementById('link-res-box').innerHTML = links;
                document.getElementById('modal-overlay').style.display = 'flex';
            });
        }

        // [í•µì‹¬ ê·œì¹™ 4, 9] ì‹¤ì‹œê°„ ë™ê¸°í™” ë° ì ‘ì† í™•ì¸
        function syncLive() {
            const params = new URLSearchParams(window.location.search);
            roomID = params.get('room'); auth = params.get('auth'); myName = params.get('name'); tIdx = params.get('t');

            if(auth === 'cap') { db.ref(`rooms/${roomID}/caps/${tIdx}`).update({ online: true }); db.ref(`rooms/${roomID}/caps/${tIdx}`).onDisconnect().update({ online: false }); }

            db.ref('rooms/' + roomID).on('value', snap => {
                const data = snap.val(); if(!data) return;

                // ì ‘ì† ë¶ˆë¹› ì—…ë°ì´íŠ¸
                if(data.status === "INTRO") {
                    document.getElementById('intro-ui').style.display = 'block';
                    document.getElementById('bid-ui').style.display = 'none';
                    document.getElementById('intro-name').innerText = data.caps[data.curIdx].name;
                    if(auth === 'host') {
                        document.getElementById('host-intro-ctrl').style.display = 'block';
                        const pList = document.getElementById('presence-list'); pList.innerHTML = ""; let onCnt = 0;
                        Object.values(data.caps).forEach(c => { if(c.online) onCnt++; pList.innerHTML += `<div><span class="presence-dot ${c.online?'online':''}"></span>${c.name}</div>`; });
                        document.getElementById('next-intro-btn').disabled = (onCnt < Object.keys(data.caps).length);
                    }
                } 
                // [í•µì‹¬ ê·œì¹™ 3, 5, 6, 7, 8] ì…ì°° ì‹œìŠ¤í…œ
                else {
                    document.getElementById('intro-ui').style.display = 'none';
                    document.getElementById('bid-ui').style.display = 'flex';
                    document.getElementById('board-p-name').innerText = data.curP || "ì„ ìˆ˜ ì„ íƒ ëŒ€ê¸°";
                    document.getElementById('board-price').innerText = data.curBid + "p";
                    document.getElementById('board-winner').innerText = data.winner || "ì—†ìŒ";
                    document.getElementById('timer-text').innerText = (data.timer / 10).toFixed(1) + "s";
                    document.getElementById('timer-bar').style.width = (data.timer / timerMax * 100) + "%";

                    if(auth === 'cap') {
                        document.getElementById('cap-bid-ctrl').style.display = 'block';
                        document.getElementById('my-pts').innerText = data.caps[tIdx].pts + "p";
                    }
                    if(auth === 'host') {
                        document.getElementById('host-bid-ctrl').style.display = 'block';
                        if(!document.getElementById('player-selector').innerHTML) {
                            data.players.forEach(p => {
                                const b = document.createElement('button'); b.innerText = p.name; b.className="btn-item active"; b.style.width="auto"; b.style.padding="10px";
                                b.onclick = () => db.ref(`rooms/${roomID}`).update({ curP: p.name, curBid: 50, timer: timerMax, alreadySold: false });
                                document.getElementById('player-selector').appendChild(b);
                            });
                        }
                    }
                    // ìë™ ë‚™ì°° ë° í¬ì¸íŠ¸ ì°¨ê°
                    if(data.timer === 0 && data.curP && !data.alreadySold && auth === 'host') {
                        db.ref(`rooms/${roomID}`).update({ alreadySold: true });
                        const winIdx = Object.keys(data.caps).find(k => data.caps[k].name === data.winner);
                        if(winIdx) db.ref(`rooms/${roomID}/caps/${winIdx}`).update({ pts: data.caps[winIdx].pts - data.curBid });
                        alert(`${data.winner} ë‚™ì°°!`);
                    }
                }
                const logBox = document.getElementById('log-chips'); logBox.innerHTML = "";
                if(data.logs) Object.values(data.logs).reverse().slice(0,5).forEach(l => { logBox.innerHTML += `<div class="btn-item active" style="padding:5px 15px;">â— ${l.u} <b>${l.a}p</b></div>`; });
            });
            if(auth === 'host') setInterval(() => { db.ref(`rooms/${roomID}/timer`).transaction(t => (t > 0 ? t - 1 : 0)); }, 100);
        }

        function nextIntro() {
            db.ref('rooms/'+roomID).once('value', snap => {
                const data = snap.val();
                if(data.curIdx + 1 < Object.keys(data.caps).length) db.ref('rooms/'+roomID).update({ curIdx: data.curIdx + 1 });
                else db.ref('rooms/'+roomID).update({ status: "BID" });
            });
        }
        function adjBid(v) { document.getElementById('bid-input-val').value = parseInt(document.getElementById('bid-input-val').value) + v; }
        function placeBid() {
            const amt = parseInt(document.getElementById('bid-input-val').value);
            db.ref('rooms/'+roomID).update({ curBid: amt, timer: Math.min(timerMax, 50), alreadySold: false });
            db.ref('rooms/'+roomID+'/logs').push({ u: myName, a: amt });
            document.getElementById('sound-success').play();
        }
        function enterHost() { window.location.href = document.getElementById('link-res-box').querySelector('.link-box').innerText.split(': ')[1]; }
        function killSession() { if(confirm("ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) db.ref('rooms/'+roomID).remove(); }
        window.onload = () => { if(window.location.search.includes('room')) navigateTo('auction'); }
    </script>
</body>
</html>
