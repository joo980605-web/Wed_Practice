<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOLVELY AUCTION</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --bg: #000000; --card: #1c1c1e; --input: #2c2c2e;
            --blue: #0A84FF; --green: #30D158; --red: #FF453A; --gold: #FFD60A;
            --text: #FFFFFF; --sub: #8E8E93;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Pretendard", sans-serif;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: var(--text); font-family: var(--font); overflow: hidden; user-select: none; }
        
        .hidden { display: none !important; }
        
        /* í™”ë©´ ê´€ë¦¬ (ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë‘ ìˆ¨ê¹€) */
        .app-view { 
            display: none; 
            width: 100%; height: 100vh; 
            flex-direction: column; align-items: center; justify-content: center; 
            position: absolute; top: 0; left: 0; 
            background: #000; z-index: 1; opacity: 0; transition: opacity 0.3s; 
        }
        /* í™œì„±í™”ëœ í™”ë©´ë§Œ ë³´ì„ */
        .app-view.active { display: flex; z-index: 10; opacity: 1; }

        /* ë¡œë”© í™”ë©´ (ê¸°ë³¸ í™œì„±í™”) */
        #v-loading { z-index: 9999; }

        .apple-card { background: var(--card); border-radius: 24px; padding: 30px; width: 90%; max-width: 650px; text-align: center; border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.7); position: relative; transition: all 0.3s; }
        .apple-card.win { border: 2px solid var(--green); box-shadow: 0 0 30px rgba(48, 209, 88, 0.2); }
        .apple-card.lose { border: 2px solid var(--red); box-shadow: 0 0 30px rgba(255, 69, 58, 0.2); }

        .btn-primary { background: var(--blue); color: #fff; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; transition: 0.1s; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }

        input { background: #2c2c2e; border: 1px solid #444; padding: 10px; border-radius: 8px; color: #fff; width: 100%; font-size: 14px; box-sizing: border-box; text-align: center; outline: none; }
        
        .grid-row { display: grid; grid-template-columns: 30px 1.5fr 2.5fr 1.5fr 0.8fr; gap: 6px; margin-bottom: 8px; align-items: center; }
        .btn-group { display: flex; background: #000; border-radius: 6px; padding: 2px; }
        .btn-opt { flex: 1; background: transparent; border: none; color: #555; padding: 6px 0; font-size: 10px; font-weight: 700; cursor: pointer; border-radius: 4px; }
        .btn-opt.active { background: #333; color: #fff; }

        .timer-big { font-size: 100px; font-weight: 800; line-height: 1; margin: 15px 0; font-variant-numeric: tabular-nums; letter-spacing: -3px; }
        .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 10px; overflow: hidden; margin: 20px 0; }
        .progress-fill { height: 100%; background: var(--blue); width: 100%; transition: width 0.1s linear; }
        .price-tag { font-size: 72px; font-weight: 700; color: var(--gold); margin: 0; letter-spacing: -2px; }
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: 700; margin-bottom: 10px; background: #333; color: #aaa; }
        
        .live-log-box { height: 130px; overflow-y: auto; background: rgba(0,0,0,0.5); border-radius: 12px; padding: 12px; margin-top: 20px; text-align: left; border: 1px solid #444; display: flex; flex-direction: column-reverse; }
        .log-entry { font-size: 13px; color: #eee; margin-bottom: 6px; border-left: 3px solid var(--blue); padding-left: 10px; }
        .log-entry span { color: var(--gold); font-weight: 700; }

        .result-container { width: 90%; max-width: 1000px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .result-card { background: #1c1c1e; padding: 20px; border-radius: 16px; border: 1px solid #333; text-align: left; }
        .result-head { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; font-weight: 700; color: var(--gold); }
        .roster-item { display: flex; justify-content: space-between; font-size: 13px; color: #ccc; margin-bottom: 5px; }

        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .copy-row { display: flex; justify-content: space-between; background: #000; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #333; align-items: center; font-size: 12px; }
    </style>
</head>
<body>

    <div id="v-loading" class="app-view active" style="z-index: 5000;">
        <div style="font-size:24px; font-weight:700;">CONNECTING...</div>
        <button id="btn-reload" class="btn-primary" style="width:auto; margin-top:20px; display:none;" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div id="v-setup" class="app-view">
        <div class="apple-card" style="max-width:1000px; padding:30px;">
            <h1 style="margin-bottom:30px;">AUCTION SETUP</h1>
            <div style="display:flex; gap:20px; text-align:left;">
                <div style="flex:1;">
                    <h3 style="color:var(--blue)">01. íŒ€ì¥ (1:4 ë¹„ìœ¨)</h3>
                    <div id="list-cap"></div>
                    <button onclick="addCap()" style="background:#333; border:none; color:#ccc; padding:10px; width:100%; border-radius:10px; margin-top:5px; cursor:pointer;">+ ì¶”ê°€</button>
                </div>
                <div style="flex:1;">
                    <h3 style="color:var(--blue)">02. ì„ ìˆ˜ ëª…ë‹¨</h3>
                    <div id="list-player"></div>
                    <button onclick="addPlayer()" style="background:#333; border:none; color:#ccc; padding:10px; width:100%; border-radius:10px; margin-top:5px; cursor:pointer;">+ ì¶”ê°€</button>
                </div>
            </div>
            <button class="btn-primary" onclick="createSession()">ì„¸ì…˜ ìƒì„± ë° ë§í¬ ë°œê¸‰</button>
        </div>
    </div>

    <div id="v-verify" class="app-view">
        <div class="apple-card">
            <h2>ë³¸ì¸ í™•ì¸</h2>
            <p style="color:var(--sub);">ì ‘ì†í•˜ë ¤ëŠ” ê³„ì •ì´ ë§ìŠµë‹ˆê¹Œ?</p>
            <div style="background:#000; padding:20px; border-radius:12px; margin:20px 0;">
                <h1 id="verify-name" style="margin:0; color:var(--blue);">NAME</h1>
            </div>
            <button class="btn-primary" style="background:var(--green); color:#000;" onclick="confirmEntry()">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="v-auction" class="app-view">
        <div class="apple-card" id="main-card">
            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--sub); margin-bottom:10px;">
                <span id="txt-phase">WAITING</span>
                <span id="txt-role">GUEST</span>
            </div>

            <div id="state-wait">
                <h1 style="font-size:40px; margin:20px 0;">íŒ€ì¥ ì ‘ì† ëŒ€ê¸°</h1>
                <div id="box-presence" style="display:flex; justify-content:center; gap:8px; margin-bottom:20px;"></div>
                <p id="txt-wait-msg" style="color:var(--sub); font-size:14px;">-</p>
                <button id="btn-host-intro" class="btn-primary hidden" onclick="setStep(1)">íŒ€ì¥ ì†Œê°œ ì‹œì‘ (Host)</button>
            </div>

            <div id="state-intro" class="hidden">
                <div style="font-size:12px; font-weight:700; color:var(--blue);">CAPTAIN INFO</div>
                <h1 id="intro-name" style="font-size:50px; margin:15px 0;">-</h1>
                <p id="intro-pts" style="color:var(--gold); font-size:24px;">-</p>
                <button id="btn-host-next" class="btn-primary hidden">ë‹¤ìŒ</button>
            </div>

            <div id="state-shuffle" class="hidden">
                <h1>SHUFFLING</h1>
                <div id="shuffle-txt" style="font-size:40px; color:var(--gold); margin:30px 0;">...</div>
            </div>

            <div id="state-show-list" class="hidden">
                <h2 style="color:var(--blue);">ê²½ë§¤ ìˆœì„œ í™•ì •</h2>
                <div id="shuffled-list-box" style="height:200px; overflow-y:auto; background:#111; padding:15px; border-radius:12px; text-align:left; margin:20px 0;"></div>
                <button id="btn-host-start-bid" class="btn-primary hidden" onclick="startFirstBid()">ì²« ë²ˆì§¸ ì„ ìˆ˜ ê²½ë§¤ ì‹œì‘</button>
            </div>

            <div id="state-bid" class="hidden">
                <div id="badge-status" class="status-badge hidden">ëŒ€ê¸° ì¤‘</div>

                <h1 id="bid-name" style="font-size:42px; margin:0;">NAME</h1>
                <div id="bid-info" style="color:var(--sub); margin-bottom:10px;">-</div>
                
                <div class="timer-big" id="bid-timer">15.0</div>
                <div class="progress-bar"><div id="bid-progress" class="progress-fill"></div></div>
                
                <div style="font-size:12px; color:var(--sub);">CURRENT BID</div>
                <div class="price-tag" id="bid-price">0</div>
                <div id="bid-winner" style="color:var(--blue); font-weight:700; margin-top:5px;">-</div>

                <div id="bid-logs" class="live-log-box"></div>

                <div id="ctrl-cap" class="hidden" style="margin-top:20px; padding-top:15px; border-top:1px solid #333;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; background:#111; padding:10px; border-radius:8px;">
                        <span style="font-size:13px; color:#888;">ë‚´ ì”ì—¬ í¬ì¸íŠ¸</span>
                        <span style="font-size:18px; font-weight:800; color:var(--gold);" id="val-my-pts">0 P</span>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:8px;">
                        <button onclick="doBid(5)" class="btn-primary" style="margin:0; background:#333; flex:1;">+5</button>
                        <button onclick="doBid(10)" class="btn-primary" style="margin:0; flex:2;">ì…ì°° (+10)</button>
                        <button onclick="doBid(50)" class="btn-primary" style="margin:0; background:#333; flex:1;">+50</button>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="inp-custom" placeholder="ê¸ˆì•¡ ì…ë ¥" style="flex:2;">
                        <button onclick="doCustomBid()" class="btn-primary" style="margin:0; flex:1; background:var(--gold); color:#000;">ì§ì ‘ ì…ì°°</button>
                    </div>
                </div>

                <div id="ctrl-host" class="hidden">
                    <button class="btn-primary" style="background:#333;" onclick="nextPlayer()">ë‹¤ìŒ ì„ ìˆ˜ ì§„í–‰ >></button>
                </div>
            </div>
        </div>
    </div>

    <div id="v-result" class="app-view">
        <h1 style="margin-bottom:30px;">ğŸ† ìµœì¢… íŒ€ êµ¬ì„± ê²°ê³¼</h1>
        <div id="result-list" class="result-container"></div>
        <button class="btn-primary" style="width:200px; margin-top:40px;" onclick="location.href=window.location.origin+window.location.pathname">ì²˜ìŒìœ¼ë¡œ</button>
    </div>

    <div id="modal-link" class="modal">
        <div class="apple-card" style="width:500px;">
            <h2>ğŸ”— ë§í¬ ìƒì„± ì™„ë£Œ</h2>
            <div id="link-box" style="margin:20px 0;"></div>
            <button class="btn-primary" onclick="goHost()">ì£¼ìµœì ì…ì¥</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA_NKmt-NWatDgjUZDO2VfSQM5r0hLWJQo",
            authDomain: "lolvelyauction.firebaseapp.com",
            databaseURL: "https://lolvelyauction-default-rtdb.firebaseio.com",
            projectId: "lolvelyauction",
            storageBucket: "lolvelyauction.firebasestorage.app",
            messagingSenderId: "916363598038",
            appId: "1:916363598038:web:a7bed88ea3541111b7d177"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomID=null, myAuth=null, myIdx=null;

        // 1. ì ‘ì† ë¡œì§ (ì•ˆì „ì¥ì¹˜)
        window.onload = () => {
            const p = new URLSearchParams(window.location.search);
            roomID = p.get('room'); myAuth = p.get('auth'); myIdx = p.get('idx');

            if(roomID) {
                // ë¡œë”©ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í‘œì‹œ
                setTimeout(() => document.getElementById('btn-reload').style.display='block', 5000);

                db.ref('rooms/'+roomID).once('value', s => {
                    if(s.exists()) {
                        if(myAuth==='CAP') checkIdentity(); 
                        else initAuction();
                    } else {
                        alert("ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ ë°©ì…ë‹ˆë‹¤.");
                        window.location.href = window.location.origin + window.location.pathname;
                    }
                }).catch(e => {
                    alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + e.message);
                });
            } else {
                switchView('v-setup');
                initSetup();
            }
        };

        function switchView(id) {
            document.querySelectorAll('.app-view').forEach(e => {
                e.classList.remove('active');
                if(e.id !== id) setTimeout(()=>e.style.display='none', 300);
            });
            const t = document.getElementById(id);
            t.style.display='flex';
            setTimeout(()=>t.classList.add('active'), 10);
        }

        // Setup Logic
        function initSetup() { addCap(); addCap(); for(let i=0;i<8;i++) addPlayer(); }
        function mkBtns(t) { return `<div class="btn-group">${(t==='T'?['I','B','S','G','E','P','D','M','GM','C']:['TOP','JGL','MID','ADC','SUP']).map(x=>`<button class="btn-opt" onclick="this.parentNode.querySelectorAll('.btn-opt').forEach(e=>e.classList.remove('active'));this.classList.add('active')">${x}</button>`).join('')}</div>`; }
        function addCap() { document.getElementById('list-cap').insertAdjacentHTML('beforeend', `<div class="grid-row item-cap"><span>C</span><input type="text" class="i-n" placeholder="ì´ë¦„">${mkBtns('T')}${mkBtns('L')}<input type="number" class="i-p" value="1000"></div>`); }
        function addPlayer() { document.getElementById('list-player').insertAdjacentHTML('beforeend', `<div class="grid-row item-pl"><span>P</span><input type="text" class="i-n" placeholder="ì´ë¦„">${mkBtns('T')}${mkBtns('L')}<span></span></div>`); }

        function createSession() {
            const caps=[], players=[];
            document.querySelectorAll('.item-cap').forEach(e => caps.push({ name:e.querySelector('.i-n').value, pts:parseInt(e.querySelector('.i-p').value)||1000, online:false, roster:[] }));
            document.querySelectorAll('.item-pl').forEach(e => players.push({ name:e.querySelector('.i-n').value, tier:e.querySelectorAll('.btn-group')[0].querySelector('.active')?.innerText||'-', lane:e.querySelectorAll('.btn-group')[1].querySelector('.active')?.innerText||'-' }));

            if(players.length !== caps.length*4) { if(!confirm(`ì„ ìˆ˜ ë¶€ì¡±(${players.length}/${caps.length*4}). ìƒì„±?`)) return; }

            roomID = "room_" + Date.now();
            db.ref('rooms/'+roomID).set({ step:0, caps, players, curP:null, curBid:0, timer:150, logs:[] });

            const base = window.location.origin + window.location.pathname;
            const hUrl = `${base}?room=${roomID}&auth=HOST`;
            let h = mkLink("ğŸ‘‘ ì£¼ìµœì", hUrl);
            caps.forEach((c,i) => h += mkLink(`âš”ï¸ ${c.name}`, `${base}?room=${roomID}&auth=CAP&idx=${i}`));
            document.getElementById('link-box').innerHTML = h;
            document.getElementById('modal-link').style.display='flex';
            document.getElementById('modal-link').dataset.url = hUrl;
        }
        function mkLink(n, u) { return `<div class="copy-row"><span>${n}</span><button class="btn-primary" style="width:auto;margin:0;padding:5px 10px;font-size:11px;" onclick="navigator.clipboard.writeText('${u}');alert('ë³µì‚¬ë¨')">ë³µì‚¬</button></div>`; }
        function goHost() { location.href = document.getElementById('modal-link').dataset.url; }

        // Verify Logic
        function checkIdentity() {
            db.ref(`rooms/${roomID}/caps/${myIdx}`).once('value', s => {
                if(!s.exists()) { alert("ì˜ëª»ëœ ì ‘ê·¼"); return; }
                document.getElementById('verify-name').innerText = s.val().name;
                switchView('v-verify');
            });
        }
        function confirmEntry() { switchView('v-loading'); initAuction(); }

        // Auction Logic
        function initAuction() {
            switchView('v-auction');
            if(myAuth==='HOST') {
                document.getElementById('txt-role').innerText = "HOST";
                document.getElementById('btn-host-intro').classList.remove('hidden');
                document.getElementById('btn-host-next').classList.remove('hidden');
                document.getElementById('btn-host-start-bid').classList.remove('hidden');
                document.getElementById('ctrl-host').classList.remove('hidden');
                setInterval(hostTimer, 100);
            } else {
                document.getElementById('txt-role').innerText = "CAPTAIN";
                document.getElementById('ctrl-cap').classList.remove('hidden');
                document.getElementById('badge-status').classList.remove('hidden');
                db.ref(`rooms/${roomID}/caps/${myIdx}`).update({online:true});
                db.ref(`rooms/${roomID}/caps/${myIdx}`).onDisconnect().update({online:false});
            }
            db.ref('rooms/'+roomID).on('value', snap => render(snap.val()));
        }

        function render(d) {
            if(!d) return;
            
            // Wait & Presence
            let on=0; let ph='';
            d.caps.forEach(c=>{ if(c.online)on++; ph+=`<div style="width:10px;height:10px;border-radius:50%;background:${c.online?'#30D158':'#333'}"></div>`; });
            document.getElementById('box-presence').innerHTML = ph;
            if(myAuth==='HOST') {
                document.getElementById('btn-host-intro').disabled = false;
                document.getElementById('txt-wait-msg').innerText = `ì ‘ì†: ${on}/${d.caps.length}`;
            }

            // Cap Info
            if(myAuth==='CAP') {
                const me = d.caps[myIdx];
                document.getElementById('val-my-pts').innerText = me.pts + " P";
                
                const card = document.getElementById('main-card');
                const badge = document.getElementById('badge-status');
                
                if(d.step>=100 && d.step<200 && d.curP) {
                    if(d.winner===me.name) { 
                        card.className="apple-card win"; badge.innerText="ğŸŸ¢ ìµœê³  ì…ì°° ì¤‘"; badge.style.background="#30D158"; badge.style.color="#000";
                    } else if(d.curBid>0) { 
                        card.className="apple-card lose"; badge.innerText="ğŸ”´ ì…ì°° ë°€ë¦¼"; badge.style.background="#FF453A"; badge.style.color="#000";
                    } else { 
                        card.className="apple-card"; badge.innerText="âšªï¸ ì…ì°° ëŒ€ê¸°"; badge.style.background="#333"; badge.style.color="#aaa";
                    }
                } else card.className="apple-card";
            }

            // State Switch
            ['wait','intro','shuffle','show-list','bid'].forEach(s=>document.getElementById(`state-${s}`).classList.add('hidden'));
            
            if(d.step===0) {
                document.getElementById('state-wait').classList.remove('hidden');
                document.getElementById('txt-phase').innerText = "WAITING";
            }
            else if(d.step<=d.caps.length) { // INTRO
                document.getElementById('state-intro').classList.remove('hidden');
                document.getElementById('txt-phase').innerText = "INTRO";
                document.getElementById('intro-name').innerText = d.caps[d.step-1].name;
                document.getElementById('intro-pts').innerText = d.caps[d.step-1].pts + " P";
                if(myAuth==='HOST') {
                    const btn = document.getElementById('btn-host-next');
                    btn.innerText = (d.step===d.caps.length)?"ì…”í”Œ ì‹œì‘":"ë‹¤ìŒ íŒ€ì¥";
                    btn.onclick = ()=>(d.step===d.caps.length)?startShuffle(d.players):setStep(d.step+1);
                }
            }
            else if(d.step===98) { // SHUFFLE
                document.getElementById('state-shuffle').classList.remove('hidden');
                if(d.players) document.getElementById('shuffle-txt').innerText = d.players[Math.floor(Math.random()*d.players.length)].name;
            }
            else if(d.step===99) { // LIST
                document.getElementById('state-show-list').classList.remove('hidden');
                const q = d.queue || [];
                document.getElementById('shuffled-list-box').innerHTML = q.map((p,i)=>`<div style="font-size:13px;padding:5px;color:#ccc;border-bottom:1px solid #222;">${i+1}. ${p.name}</div>`).join('');
            }
            else if(d.step>=100) { // BID
                if(d.step === 200 || !d.curP) { // RESULT
                    switchView('v-result');
                    let h=''; 
                    d.caps.forEach(c=>{
                        let r = (c.roster||[]).map(m=>`<div class="roster-item"><span>${m.name}</span><span>${m.bid}p</span></div>`).join('');
                        h+=`<div class="result-card"><div class="result-head"><span>${c.name}</span><span>${c.pts}p</span></div>${r||'<div style="color:#666;font-size:13px;">ì˜ì… ì—†ìŒ</div>'}</div>`;
                    });
                    document.getElementById('result-list').innerHTML=h;
                    return;
                }
                
                document.getElementById('state-bid').classList.remove('hidden');
                document.getElementById('txt-phase').innerText = "AUCTION";
                document.getElementById('bid-name').innerText = d.curP.name;
                document.getElementById('bid-info').innerText = `${d.curP.tier} â€¢ ${d.curP.lane}`;
                document.getElementById('bid-price').innerText = d.curBid;
                document.getElementById('bid-winner').innerText = d.winner==="None"?"ì…ì°° ëŒ€ê¸°":`${d.winner}ë‹˜ ìµœê³ ê°€`;
                document.getElementById('bid-timer').innerText = (d.timer/10).toFixed(1);
                document.getElementById('bid-progress').style.width = (d.timer/150*100)+"%";
                
                let lh=''; if(d.logs) Object.values(d.logs).reverse().forEach(l=>lh+=`<div class="log-entry">${l}</div>`);
                document.getElementById('bid-logs').innerHTML = lh;
            }
        }

        // --- Logic Functions ---
        function setStep(n) { db.ref('rooms/'+roomID).update({step:n}); }
        function startShuffle(p) { 
            db.ref('rooms/'+roomID).update({step:98}); 
            const q = [...p].sort(()=>Math.random()-0.5);
            setTimeout(() => { db.ref('rooms/'+roomID).update({step:99, queue:q}); }, 3000);
        }
        function startFirstBid() { nextPlayer(); }
        function nextPlayer() {
            db.ref('rooms/'+roomID).once('value', s=>{
                const d=s.val(), q=d.queue||[];
                if(q.length===0) { db.ref('rooms/'+roomID).update({step:200, curP:null}); return; }
                const n=q.shift();
                db.ref('rooms/'+roomID).update({step:100, curP:n, curBid:0, timer:150, winner:"None", sold:false, queue:q});
            });
        }
        function hostTimer() {
            db.ref('rooms/'+roomID).once('value', s=>{
                const d=s.val();
                if(d.step>=100 && d.step<200 && d.curP && !d.sold) {
                    if(d.timer>0) db.ref('rooms/'+roomID+'/timer').set(d.timer-1);
                    else handleSold(d);
                }
            });
        }
        function handleSold(d) {
            db.ref('rooms/'+roomID).update({sold:true});
            if(d.winner!=="None") {
                const i=d.caps.findIndex(c=>c.name===d.winner);
                const np = d.caps[i].pts - d.curBid;
                let r = d.caps[i].roster||[]; 
                r.push({name: d.curP.name, bid: d.curBid});
                db.ref(`rooms/${roomID}/caps/${i}`).update({pts:np, roster:r});
                log(`[ë‚™ì°°] ${d.winner} -> ${d.curP.name}`);
            } else log(`[ìœ ì°°] ${d.curP.name}`);
        }
        function doBid(add) {
            db.ref('rooms/'+roomID).runTransaction(d => {
                if(!d||d.sold||d.step<100) return;
                const me = d.caps[myIdx];
                const next = d.curBid + add;
                if(me.pts < next) return;
                d.curBid = next; d.winner = me.name; d.timer = Math.min(150, d.timer+20);
                if(!d.logs) d.logs=[]; d.logs.push(`<b>${me.name}</b> ì…ì°°: ${next}p`);
                return d;
            });
        }
        function doCustomBid() { const v=parseInt(document.getElementById('inp-custom').value); if(v>0) doBid(v); document.getElementById('inp-custom').value=''; }
        function log(m) { db.ref('rooms/'+roomID+'/logs').push(m); }
    </script>
</body>
</html>
